#!/bin/bash

set -ueo pipefail

# Turn the old school BUILDKITE_PLUGIN_DOCKER_COMPOSE_BUILDKITE_PLUGIN_GIT_
# environment variables into the desired BUILDKITE_PLUGIN_DOCKER_COMPOSE_
# variables. This can be removed once we update the bootstrap for this new
# plugin naming convention.
eval $(env | grep "_BUILDKITE_PLUGIN_GIT_" | sed "s/_BUILDKITE_PLUGIN_GIT_/_/g" | sed 's/^/export /')

## SET UP SHARED FUNCTIONS

# Shows the command about to be run, and exits if it fails
buildkite-run() {
  echo -e "\033[90m$\033[0m $1"
  eval "$1"
  EVAL_EXIT_STATUS=$?

  if [[ $EVAL_EXIT_STATUS -ne 0 ]]; then
    exit $EVAL_EXIT_STATUS
  fi
}

# Returns the name of the docker compose project for this build
docker_compose_project_name() {
  # No dashes or underscores because docker-compose will remove them anyways
  echo "buildkite"${BUILDKITE_JOB_ID//-}
}

# Returns the name of the docker compose container that corresponds to the given service
docker_compose_container_name() {
  echo "$(docker_compose_project_name)_$1"
}

docker_compose_config_file() {
  echo "${BUILDKITE_PLUGIN_DOCKER_COMPOSE_CONFIG:-docker-compose.yml}"
}

# Runs the docker-compose command, scoped to the project, with the given arguments
run_docker_compose() {
  buildkite-run "docker-compose -f $(docker_compose_config_file) -p $(docker_compose_project_name) $1"
}

build_meta_data_image_tag_key() {
  echo "docker-compose-plugin-built-image-tag-$1"
}

## BUILD OR RUN

DIR="$(cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd)"

echo "~~~ Debug env output"
buildkite-run "env"

if [[ ! -z "${BUILDKITE_PLUGIN_DOCKER_COMPOSE_BUILD:-}" ]]; then
  . "$DIR/hooks/commands/build.sh"
elif [[ ! -z "${BUILDKITE_PLUGIN_DOCKER_COMPOSE_RUN:-}" ]]; then
  . "$DIR/hooks/commands/run.sh"
else
  echo "+++ Docker Compose plugin error"
  echo "No build or run options were specified"
  exit 1
fi
